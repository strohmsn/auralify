<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<!-- polyfill -->
	<script src="midi-js/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="midi-js/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="midi-js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="midi-js/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="midi-js/js/midi/gm.js" type="text/javascript"></script>
	<script src="midi-js/js/midi/loader.js" type="text/javascript"></script>
	<script src="midi-js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="midi-js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="midi-js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="midi-js/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="midi-js/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
	<script type="text/javascript">
	window.onload = function () {
		MIDI.loadPlugin({
			soundfontUrl: "midi-js/examples/soundfont/",
			instrument: "acoustic_grand_piano",
			onprogress: function(state, progress) {
				console.log(state, progress);
			},
			onsuccess: function() {
				console.log("Init success!");
				MIDI.setVolume(0, 127);
			}
		});
	};
	
	var speed = 2000; // play one note every 2000 ms
	var note = 45; // the MIDI start note
	var velocity = 127; // how hard the note hits
	
	var intervalsMajor = [2, 2, 1, 2, 2, 2, 1] // intervals for the major scale
	var intervalsNaturalMinor = [2, 1, 2, 2, 1, 2, 2] // intervals for the natural minor scale
	var intervalsMelodicMinor = [2, 1, 2, 2, 2, 2, 1] // intervals for the melodic minor scale
	
	var intervals = intervalsMajor;
	var scale = [];
	var cadence = [];
	var running = false;
	
	function calculateScale(numberOfOctaves) {
		var scale = [note];
		var nextNote = note;
		for (var octave = 0; octave < numberOfOctaves; octave++) {
			for (var interval = 0; interval < intervals.length; interval++) {
				nextNote += intervals[interval];
				scale.push(nextNote);
			}
		}
		
		console.log("Scale: " + scale);
		return scale;
	}
	
	function calculateCadence() {
		var scaleForCadence = calculateScale(2);
		var tonic = [scaleForCadence[0], scaleForCadence[2], scaleForCadence[4]];
		var subdominant = [scaleForCadence[3], scaleForCadence[5], scaleForCadence[7]];
		var dominant = [scaleForCadence[4], scaleForCadence[6], scaleForCadence[8]];
		
		return [tonic, subdominant, dominant, tonic];
	}
	
	function getRandomNoteFromScale() {
		return scale[Math.floor(Math.random() * scale.length)];
	}
	
	function playNotes(notesToPlay, noteNumber) {
		var noteToPlay = notesToPlay[noteNumber];
	
		if (Array.isArray(noteToPlay)) {
			MIDI.chordOn(0, noteToPlay, velocity, 0);
			console.log("Playing chord " + noteToPlay + " (" + MIDI.noteToKey[noteToPlay[0]] + "," + MIDI.noteToKey[noteToPlay[1]] + "," + MIDI.noteToKey[noteToPlay[2]] + ")");
		} else if (typeof(noteToPlay) === "number") {
			MIDI.noteOn(0, noteToPlay, velocity, 0);
			// TODO: Add scale degree?
			console.log("Playing note " + noteToPlay + " (" + MIDI.noteToKey[noteToPlay] + ")");
		}
			
		setTimeout(function() {
			if (Array.isArray(noteToPlay)) {
				MIDI.chordOff(0, noteToPlay, 0);
			} else if (typeof(noteToPlay) === "number") {
				MIDI.noteOff(0, notesToPlay[noteNumber], 0);
			}		
			
			// Play next note/chord
			noteNumber++;			
			if (running && noteNumber < notesToPlay.length) {
				playNotes(notesToPlay, noteNumber);
			}
		}, speed);
	}

	function start() {
		console.log("Started");
		running = true;
		
		cadence = calculateCadence();
		scale = calculateScale(1);
		
		notesToPlay = cadence;
		
		notesToPlay.push(null);
				
		for (var i = 0; i < 12; i++) {
			notesToPlay.push(getRandomNoteFromScale());
		}
		
		playNotes(notesToPlay, 0);
	}
	
	function stop() {
		running = false;
		console.log("Stopped");
	}
	
	</script>
	
	<button onclick="start()">Start</button>
	<button onclick="stop()">Stop</button>
</body>
</html>